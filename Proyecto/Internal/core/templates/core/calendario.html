<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Parchate Â· Calendario</title>
<style>
  @font-face{font-family:"Tokyo";src:url("Tokyo.ttf") format("truetype");font-display:swap}
  :root{
    --primary:#FCAF56; --secondary:#7795FC;
    --g0:#fff; --g50:#f9fafb; --g100:#f3f4f6; --g200:#e5e7eb; --g300:#d1d5db; --g600:#4b5563; --g900:#111827;
    --ring:0 0 0 3px rgba(119,149,252,.35); --shadow:0 8px 18px rgba(0,0,0,.12);
    --touch:44px; --radius:14px;

    /* Colores por prioridad */
    --p-alta:#FCA5A5;   /* rojo suave */
    --p-media:#FCD34D;  /* amarillo */
    --p-baja:#A7F3D0;   /* verde menta */

    /* Alturas de layout (coinciden con el UI actual) */
    --h-header:64px;
    --h-footer:60px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--g50);color:var(--g900);
    font:16px/1.5 "Tokyo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  .app{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}

  /* Header */
  header{position:sticky;top:0;z-index:10;background:var(--g0);border-bottom:1px solid var(--g200)}
  .head{max-width:1100px;margin:auto;padding:10px 16px;height:var(--h-header);display:flex;align-items:center;gap:12px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary))}
  .title{font-weight:900;color:var(--secondary)}
  .spacer{margin-left:auto}
  .btn{min-height:var(--touch);padding:10px 14px;border-radius:12px;border:1px solid transparent;font-weight:800;cursor:pointer;text-decoration:none;}
  .btn-primary{background:var(--primary);color:#111}
  .btn:focus-visible{outline:none;box-shadow:var(--ring)}

  /* Contenido */
  .container{
    max-width:100%;padding:16px 0;
    display:flex;flex-direction:column;
    height:calc(100dvh - var(--h-header) - var(--h-footer)); /* ocupa el alto disponible sin scroll */
    min-height:0;
  }
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;padding: 0 16px;}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--g0);border:1px solid var(--g200);font-weight:800}
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

  /* Calendario: cabecera + cuerpo con alturas proporcionadas */
  .calendar-wrap{flex:1;min-height:0;display:grid;grid-template-rows:auto 1fr}
  .grid-head{
    display:grid;grid-template-columns:80px repeat(7,1fr);
    background:var(--g100);border:1px solid var(--g200);border-bottom:none;border-top-left-radius:12px;border-top-right-radius:12px;
  }
  .colhead{padding:8px;font-weight:900;text-align:center;border-right:1px solid var(--g200)}
  .colhead:first-child{text-align:right;padding-right:12px}
  .colhead:last-child{border-right:none}

  .grid-body{
    display:grid;grid-template-columns:80px repeat(7,1fr);
    grid-auto-rows:1fr;           /* 13 filas de igual altura -> todo cabe sin scroll */
    border:1px solid var(--g200);
    border-bottom-left-radius:12px;border-bottom-right-radius:12px;
    background:var(--g0);overflow-y:scroll;overflow-x:hidden;
  }
  .time{
    padding:8px;border-right:1px solid var(--g200);text-align:right;color:var(--g600);
    border-top:1px solid var(--g200);
  }
  .slot{
    position:relative;border-right:1px solid var(--g200);border-top:1px solid var(--g200);
    /* sin min-height fija: la altura la reparte la grilla */
  }
  .slot:last-child{border-right:none}

  .event{
    position:absolute;left:6px;right:6px;top:4px;bottom:4px;   /* llena la fila visualmente */
    border-radius:10px;padding:8px 10px;box-shadow:var(--shadow);
    border:1px solid rgba(0,0,0,.06);display:grid;gap:4px
  }
  .alta{background:var(--p-alta)} .media{background:var(--p-media)} .baja{background:var(--p-baja)}
  .event h4{margin:0;font-size:1rem}
  .event .meta{font-size:.9rem;color:#1f2937}
  .ev-actions{display:flex;gap:6px;margin-top:4px}
  .ev-btn{min-height:36px;padding:6px 10px;border-radius:8px;border:1px solid var(--g300);background:var(--g0);font-weight:800;cursor:pointer}
  .ev-btn:focus-visible{outline:none;box-shadow:var(--ring)}

  /* Footer nav */
  footer{position:sticky;bottom:0;background:var(--g0);border-top:1px solid var(--g200)}
  .nav{max-width:1100px;margin:auto;height:var(--h-footer);display:flex;align-items:center;justify-content:space-around}
  .nav a{padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--g900);font-weight:800}
  .nav a.primary{background:var(--secondary);color:#fff}
  .nav a:focus-visible{outline:none;box-shadow:var(--ring)}

  .sr-only{position:absolute;width:1px;height:1px;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;padding:0}

  /* ====== RESPONSIVE SIDEBAR ====== */
  .overlay{display:none}
  @media (max-width:960px){
    .page{grid-template-columns:1fr}
    aside{position:fixed; inset:0 auto 0 0; width:280px; transform:translateX(-100%); transition:transform .2s ease; z-index:20}
    aside.open{transform:none; box-shadow:var(--shadow)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .hamb{min-height:var(--touch); padding:8px 12px; border-radius:12px; border:1px solid var(--g300); background:var(--g0); cursor:pointer; font-weight:800}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35)}
    .overlay.show{display:block}
  }
  .event.materia {
    border-left: 10px solid #2563eb; /* azul */
  }
  .event.evento {
    border-left: 10px solid #059669; /* verde */
  }
  .event {
    color: #1f2937;
    backdrop-filter: blur(4px);
    border-radius: 12px;
  }
  .event.materia::before {
    content: "ðŸ“˜";
    margin-right: 4px;
    font-size: 12px;
  }
  .event.evento::before {
    content: "ðŸ“…";
    margin-right: 4px;
    font-size: 12px;
  }
  .event {
    padding: 5px 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-radius: 12px;
    font-size: 0.88rem;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .event:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
  }
  .priority-alta {
    background: var(--p-alta);
  }
  .priority-media {
    background: var(--p-media);
  }
  .priority-baja {
    background: var(--p-baja);
  }
  .event {
    position: relative;
  }
  .grid-head {
  background: linear-gradient(to bottom, #FCAF56, #7795FC);
  }
  .event {
  overflow: visible !important;
  position: relative !important;
  }
</style>
</head>
<body>
  <div class="app">
    <header role="banner">
      <div class="head">
        <div class="logo" aria-hidden="true"></div>
        <div class="title" aria-label="Calendario del usuario">Calendario</div>
        <div class="spacer"></div>
        <a class="btn btn-primary" href="{% url 'agregar_materia' %}" aria-label="AÃ±adir materia">AÃ±adir materia</a>
      </div>
    </header>

    <main class="container" role="main">
      <section class="toolbar" aria-label="Leyenda">
        <div class="legend">
          <span class="chip"><span class="dot" style="background:var(--p-alta)"></span> Prioridad alta</span>
          <span class="chip"><span class="dot" style="background:var(--p-media)"></span> Prioridad media</span>
          <span class="chip"><span class="dot" style="background:var(--p-baja)"></span> Prioridad baja</span>
        </div>
      </section>

      <!-- Calendario -->

      <section class="calendar-wrap" aria-labelledby="cal-title"> 
        <div class="grid-head" role="row">
          <div class="colhead">Hora</div>
          <div class="colhead">Lun</div><div class="colhead">Mar</div><div class="colhead">MiÃ©</div>
          <div class="colhead">Jue</div><div class="colhead">Vie</div><div class="colhead">SÃ¡b</div><div class="colhead">Dom</div>
        </div>
        <div id="grid" class="grid-body" role="grid" aria-label="Calendario semanal (compacto)"></div>
      </section>
    </main>

    <footer role="contentinfo">
      <nav class="nav" aria-label="NavegaciÃ³n principal">
        <a class="btn btn-primary" href="/area_privada/">Volver</a>
        <a href="/actividades/">Inicio</a>
        <a href="/materias_y_eventos/">Materias y eventos</a>
        <a class="primary" href="/calendario/" aria-current="page">Calendario</a>
      </nav>
    </footer>
  </div>

<script>
  /* ---------- Calendario (cabecera + cuerpo con alturas iguales) ---------- */
  const grid = document.getElementById('grid');

  // Mapeo de dÃ­as espaÃ±ol a Ã­ndice (0-6)
  const daysMap = {
    'Lunes': 0, 'Martes': 1, 'MiÃ©rcoles': 2,
    'Jueves': 3, 'Viernes': 4, 'SÃ¡bado': 5, 'Domingo': 6
  };

  // Construir filas 07:00â€“20:00
  for(let h=7; h<=20; h++){
    const timeCell = document.createElement('div');
    timeCell.className='time';
    timeCell.textContent = String(h).padStart(2,'0') + ':00';
    grid.appendChild(timeCell);
    for(let day=0; day<7; day++){
      const slot = document.createElement('div');
      slot.className='slot';
      slot.dataset.day = String(day);
      slot.dataset.hr  = String(h);
      grid.appendChild(slot);
    }
  }

  // Obtener datos desde el backend
  const materias = JSON.parse('{{ materias_json|escapejs }}');
  const eventos = JSON.parse('{{ eventos_json|escapejs }}');

  // Renderizar materias
  function placeMateriaEvent(mat){
    // Parsear horario
    const parts = mat.horario.split(' ');
    if(parts.length < 2) return;
    
    const dia = parts[0];
    const horas = parts[1].split('-');
    const dayIndex = daysMap[dia];
    const startHour = parseInt(horas[0].split(':')[0], 10);
    
    if(dayIndex === undefined) return;

    const target = document.querySelector(`.slot[data-day="${dayIndex}"][data-hr="${startHour}"]`);
    if(!target) return;
    // 1. Crear el elemento de nombre (TÃ­tulo <h4>)
    const nameEl = document.createElement("h4");
    nameEl.textContent = mat.name; 
    
    // 2. Crear el elemento meta (Hora o duraciÃ³n)
    const metaEl = document.createElement("div");
    metaEl.className = "meta";
    // Muestra solo el rango de horas (ej: 08:00-09:30)
    const horarioRange = mat.horario.split(' ')[1];
    if (horarioRange) {
        metaEl.textContent = horarioRange; 
    }
    const el = document.createElement("div");
    const prioridadNombres = {1: 'Baja', 2: 'Media', 3: 'Alta'};
    const prioridadClases  = {1: 'priority-baja', 2: 'priority-media', 3: 'priority-alta'};

    const priorityClass = prioridadClases[mat.prioridad];

    el.appendChild(nameEl);
    el.appendChild(metaEl);

    el.className = `event materia ${priorityClass}`;

    target.appendChild(el);
}

  // Renderizar eventos
  function placeEventoCalendario(evt){

    function parseLocalDatetime(dtString) {
      const [datePart, timePart] = dtString.split('T');
      const [y, m, d] = datePart.split('-').map(Number);
      const [h, min] = timePart.split(':').map(Number);
      return new Date(y, m - 1, d, h, min);
    }

    const start = parseLocalDatetime(evt.start);
    const end   = parseLocalDatetime(evt.end);

    // Convertir correctamente: getDay() 0=Dom, 1=Lun... â†’ dayIndex 0=Lun, 6=Dom
    let dayIndex = start.getDay() - 1;
    if(dayIndex === -1) dayIndex = 6; // Si es domingo (0), pasar a 6
    
    const startHour = start.getHours();
    
    const target = document.querySelector(`.slot[data-day="${dayIndex}"][data-hr="${startHour}"]`);
    if(!target) {
      console.warn(`No se encontrÃ³ slot para evento: ${evt.name}, dÃ­a ${dayIndex}, hora ${startHour}`);
      return;
    }
    // 1. Crear el elemento de nombre (TÃ­tulo <h4>)
    const nameEl = document.createElement("h4");
    nameEl.textContent = evt.name; // <--- Usando evt.name
    
    // 2. Crear el elemento meta (Hora)
    const metaEl = document.createElement("div");
    metaEl.className = "meta";
    // Formatear la hora de inicio
    metaEl.textContent = `Inicia: ${evt.start.substring(11,16)}`;
    const el = document.createElement("div");
    const prioridadNombres = {1: 'Baja', 2: 'Media', 3: 'Alta'};
    const prioridadClases  = {1: 'priority-baja', 2: 'priority-media', 3: 'priority-alta'};
    const priorityClass = prioridadClases[evt.prioridad];
    el.appendChild(nameEl);
    el.appendChild(metaEl);
    el.className = `event evento ${priorityClass}`;

    target.appendChild(el);
}

  // Renderizar todos
  materias.forEach(placeMateriaEvent);
  eventos.forEach(placeEventoCalendario);

  
  const today = new Date().getDay() - 1;
  if (today === -1) today = 6;

  document.querySelectorAll(`.slot[data-day="${today}"]`)
    .forEach(s => s.style.background = "rgba(34, 197, 94, 0.1)"); // Marcar el dia actual con verde

  /* ===== TOOLTIP INTELIGENTE ===== */

const tooltip = document.getElementById("tooltip");

document.querySelectorAll('.event').forEach(ev => {
    ev.addEventListener('mouseenter', e => {

        const rect = ev.getBoundingClientRect();
        const tt = tooltip.getBoundingClientRect();

        // PosiciÃ³n por defecto (arriba)
        let top = rect.top - tt.height - 8;
        let left = rect.left + rect.width / 2 - tt.width / 2;

        // Si se sale por arriba â†’ mostrar abajo
        if (top < 0) {
            top = rect.bottom + 8;
        }
        tooltip.style.top = top + "px";
        tooltip.style.left = left + "px";
    });

    ev.addEventListener('mouseleave', () => {
        tooltip.style.display = "none";
    });
});
</script>
</body>
</html>