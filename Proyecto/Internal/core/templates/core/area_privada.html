<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Parchate ¬∑ √Årea privada y gesti√≥n del tiempo</title>
<style>
  :root{
    --primary:#FCAF56; --secondary:#7795FC;
    --g0:#fff; --g50:#f9fafb; --g100:#f3f4f6; --g200:#e5e7eb; --g300:#d1d5db; --g600:#4b5563; --g900:#111827;
    --ring:0 0 0 3px rgba(119,149,252,.35); --shadow:0 10px 24px rgba(0,0,0,.12);
    --radius:16px; --touch:44px;
    --p-alta:#FCA5A5;  --p-media:#FCD34D; --p-baja:#A7F3D0;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--g50);color:var(--g900);font:16px/1.5 "Tokyo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* ====== LAYOUT ====== */
  .page{min-height:100dvh;display:grid;grid-template-columns:280px 1fr}
  aside{
    position:sticky; top:0; align-self:start; height:100dvh;
    background:var(--g0); border-right:1px solid var(--g200); padding:12px; z-index:10;
  }
  main{padding:16px; display:grid; gap:16px; min-width:0}
  .grid{display:grid;gap:16px}
  @media (min-width:1100px){ .grid{grid-template-columns:1.2fr 1fr} }

  /* ====== NAV LATERAL ====== */
  .brand{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary))}
  .appname{font-weight:900;color:var(--secondary)}
  nav{margin-top:8px;display:grid;gap:6px}
  .nav-btn{display:flex;align-items:center;gap:10px;min-height:var(--touch);padding:10px 12px;border-radius:12px;background:transparent;border:1px solid transparent;text-decoration:none;color:var(--g900);font-weight:800}
  .nav-btn:hover{background:var(--g100)}
  .nav-btn:focus-visible{outline:none;box-shadow:var(--ring)}
  .current{background:rgba(119,149,252,.12); border:1px solid rgba(119,149,252,.35); color:#1f2a6a}

  /* ====== ELEMENTOS ====== */
  .title{margin:0 0 8px;color:#FCAF56}
  .panel{background:var(--g0);border:1px solid var(--g200);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.05);padding:14px}
  .btn{min-height:var(--touch);padding:8px 10px;border-radius:12px;border:1px solid transparent;font-weight:800;cursor:pointer;text-decoration:none;}
  .btn:focus-visible{outline:none;box-shadow:var(--ring)}
  .btn-primary-M{background:#2563eb; color:black}
  .btn-primary-E{background:#059669; color:black}
  .link{color:var(--secondary);font-weight:800;text-decoration:none;padding:6px 8px;border-radius:10px}
  .link:focus-visible{outline:none;box-shadow:var(--ring)}

  /* ====== CALENDARIO COMPACTO (cabecera + cuerpo) ====== */
  .calendar-wrap{display:grid;grid-template-rows:auto 1fr;gap:0}
  .grid-head{
    display:grid;grid-template-columns:64px repeat(7,1fr);
    background:var(--g100);border:1px solid var(--g200);border-bottom:none;
    border-top-left-radius:12px;border-top-right-radius:12px;
  }
  .colhead{padding:6px;font-weight:900;text-align:center;border-right:1px solid var(--g200)}
  .colhead:first-child{text-align:right;padding-right:10px}
  .colhead:last-child{border-right:none}

  .grid-body{
    display:grid;grid-template-columns:64px repeat(7,1fr);
    grid-auto-rows:1fr; /* alturas iguales */
    height:550px;       /* <<< altura fija desktop */
    overflow:hidden;
    border:1px solid var(--g200);
    border-bottom-left-radius:12px;border-bottom-right-radius:12px;
    background:var(--g0);
  }
  @media (max-width:960px){ .grid-body{height:420px} } /* altura m√≥vil */

  .time{padding:6px;border-right:1px solid var(--g200);text-align:right;color:var(--g600);border-top:1px solid var(--g200)}
  .slot{position:relative;border-right:1px solid var(--g200);border-top:1px solid var(--g200)}
  .slot:last-child{border-right:none}
  .event{
    position:absolute; inset:3px; border-radius:10px; padding:6px 8px;
    border:1px solid rgba(0,0,0,.06); box-shadow:0 1px 2px rgba(0,0,0,.12);
    display:flex; flex-direction:column; gap:2px; overflow:hidden;
  }
  .event h4{margin:0;font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .event .meta{font-size:.85rem;color:#1f2937; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .ev-actions{margin-top:auto; display:flex; gap:6px}
  .ev-btn{min-height:32px;padding:4px 8px;border-radius:8px;border:1px solid var(--g300);background:var(--g0);font-weight:800;cursor:pointer;text-decoration:none;color:inherit}
  .ev-btn:focus-visible{outline:none;box-shadow:var(--ring)}

  /* ====== TAREAS ====== */
  .list{display:grid;gap:10px}
  .item{background:var(--g0);border:1px solid var(--g200);border-radius:12px;padding:10px;display:grid;gap:6px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .meta{color:var(--g600)}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(119,149,252,.35);background:rgba(119,149,252,.12);color:#1f2a6a;font-weight:800}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .act{min-height:36px;padding:6px 10px;border-radius:10px;border:1px solid var(--g300);background:var(--g0);cursor:pointer;font-weight:800}
  .danger{border-color:#fecaca;background:#fee2e2;color:#7f1d1d}

  /* ====== RESPONSIVE SIDEBAR ====== */
  .overlay{display:none}
  @media (max-width:960px){
    .page{grid-template-columns:1fr}
    aside{position:fixed; inset:0 auto 0 0; width:280px; transform:translateX(-100%); transition:transform .2s ease; z-index:20}
    aside.open{transform:none; box-shadow:var(--shadow)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .hamb{min-height:var(--touch); padding:8px 12px; border-radius:12px; border:1px solid var(--g300); background:var(--g0); cursor:pointer; font-weight:800}
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35)}
    .overlay.show{display:block}
  }
  .event.materia {
    border-left: 10px solid #2563eb; /* azul */
  }
  .event.evento {
    border-left: 10px solid #059669; /* verde */
  }
  .event {
    color: #1f2937;
    backdrop-filter: blur(4px);
    border-radius: 12px;
  }
  .event.materia::before {
    content: "üìò";
    margin-right: 4px;
    font-size: 12px;
  }
  .event.evento::before {
    content: "üìÖ";
    margin-right: 4px;
    font-size: 12px;
  }
  .event {
    padding: 5px 10px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    border-radius: 12px;
    font-size: 0.88rem;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .event:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 12px rgba(0,0,0,.15);
  }
  .priority-alta {
    background: var(--p-alta);
  }
  .priority-media {
    background: var(--p-media);
  }
  .priority-baja {
    background: var(--p-baja);
  }
  .event {
    position: relative;
  }
  .grid-head {
  background: linear-gradient(to bottom, #FCAF56, #7795FC);
  }
  .event {
  overflow: visible !important;
  position: relative !important;
  }
</style>
</head>
<body>
  <div class="page">
    <!-- Sidebar -->
    <aside id="sidebar" aria-label="Men√∫ lateral">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="appname">Parchate</div>
      </div>
      <nav>
        <a class="nav-btn" href="/actividades/">Inicio / Actividades</a>
        <a class="nav-btn current" href="/area_privada/" aria-current="page">√Årea privada y gesti√≥n del tiempo</a>
        <a class="nav-btn" href="/perfil/">Perfil de usuario</a>
        <a class="nav-btn" href="/logout/">Cerrar sesi√≥n</a>
      </nav>
    </aside>
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Contenido -->
    <main role="main">
      <div class="topbar" style="display:none">
        <button id="btnHamb" class="hamb" aria-controls="sidebar" aria-expanded="false">‚ò∞ Men√∫</button>
      </div>

      <h1 class="title">√Årea privada y gesti√≥n del tiempo</h1>

      <div class="grid">
        <!-- Calendario -->
        <section class="panel" aria-labelledby="cal-title">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <h2 id="cal-title" class="title" style="margin:0">Calendario</h2>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn btn-primary-M" href="{% url 'agregar_materia' %}">A√±adir materiaüìò</a>
              <a class="btn btn-primary-E" href="/agregar_evento/">A√±adir eventoüìÖ</a>
              <a class="link" href="/calendario/">Ver en pantalla completa</a>
            </div>
          </div>

          <div class="calendar-wrap">
            <div class="grid-head" role="row">
              <div class="colhead">Hora</div>
              <div class="colhead">Lun</div><div class="colhead">Mar</div><div class="colhead">Mi√©</div>
              <div class="colhead">Jue</div><div class="colhead">Vie</div><div class="colhead">S√°b</div><div class="colhead">Dom</div>
            </div>
            <div id="grid" class="grid-body" role="grid" aria-label="Calendario semanal (compacto)"></div>
          </div>
        </section>

        <!-- Tareas -->
        <section class="panel" aria-labelledby="tasks-title">
            
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <h2 id="tasks-title" class="title" style="margin:0">Tus Tareas Por Realizar</h2>
            <div>
              <a class="link" href="/tareas_realizadas/">Ver realizadas</a>
              <a class="link" href="{% url 'crear_tarea' %}">Agregar </a>
            </div>
          </div>
          <div id="taskList" class="list" role="list">
              {% if tareas %}
              {% for tarea in tareas %}
              <article class="item" role="listitem">
                <div class="row">
                  <strong>{{ tarea.nombre_tarea }}</strong>
                  <span class="chip">P{{ tarea.prioridad }}</span>
                </div>
                <div class="meta">Fecha l√≠mite: {{ tarea.fecha_vencimiento }}</div>
                <div class="actions">
                  <a class="act" href="#">Ver</a>
                  <form action="/marcar_realizada/" method="POST" style="display:inline;" class="marcar-tarea-form">
                      {% csrf_token %}
                      <input type="hidden" name="id_tarea" value="{{ tarea.id }}">
                      <button class="act" type="submit">Marcar como realizada</button>
                  </form>
                   <form action="/eliminar_tarea/" method="POST" style="display:inline;" class="eliminar-tarea-form">
                       {% csrf_token %}
                       <input type="hidden" name="id_tarea" value="{{ tarea.id }}">
                       <button class="act danger" type="submit">Eliminar</button>
                   </form>
                </div>
              </article>
              {% endfor %}
              {% else %}
              <div style="text-align: center; color: var(--g600); padding: 20px;">¬°No tienes tareas pendientes! üéâ</div>
              {% endif %}
          </div>
        </section>
      </div>
    </main>
  </div>
  <div id="tooltip" style="
    position: fixed;
    background: #626ad5;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,.25);
    z-index: 99999;
    pointer-events: none;
    display: none;
  "></div>

<script>
  /* ---------- Sidebar responsive ---------- */
  const btn=document.getElementById('btnHamb');
  const sidebar=document.getElementById('sidebar');
  const ov=document.getElementById('overlay');
  function open(){ sidebar.classList.add('open'); ov.classList.add('show'); btn?.setAttribute('aria-expanded','true'); }
  function close(){ sidebar.classList.remove('open'); ov.classList.remove('show'); btn?.setAttribute('aria-expanded','false'); }
  btn?.addEventListener('click', ()=> sidebar.classList.contains('open') ? close() : open());
  ov?.addEventListener('click', close);

  const mq = window.matchMedia('(max-width: 960px)');
  function applyMQ(){ const tb=document.querySelector('.topbar'); if(tb){ tb.style.display = mq.matches ? 'flex':'none'; } }
  mq.addEventListener('change', applyMQ); applyMQ();

  /* ---------- Calendario (cabecera + cuerpo con alturas iguales) ---------- */
  const grid = document.getElementById('grid');

  // Mapeo de d√≠as espa√±ol a √≠ndice (0-6)
  const daysMap = {
    'Lunes': 0, 'Martes': 1, 'Mi√©rcoles': 2,
    'Jueves': 3, 'Viernes': 4, 'S√°bado': 5, 'Domingo': 6
  };

  // Construir filas 07:00‚Äì20:00
  for(let h=7; h<=20; h++){
    const timeCell = document.createElement('div');
    timeCell.className='time';
    timeCell.textContent = String(h).padStart(2,'0') + ':00';
    grid.appendChild(timeCell);
    for(let day=0; day<7; day++){
      const slot = document.createElement('div');
      slot.className='slot';
      slot.dataset.day = String(day);
      slot.dataset.hr  = String(h);
      grid.appendChild(slot);
    }
  }

  // Obtener datos desde el backend
  const materias = JSON.parse('{{ materias_json|escapejs }}');
  const eventos = JSON.parse('{{ eventos_json|escapejs }}');

  // Renderizar materias
  function placeMateriaEvent(mat){
    // Parsear horario
    const parts = mat.horario.split(' ');
    if(parts.length < 2) return;
    
    const dia = parts[0];
    const horas = parts[1].split('-');
    const dayIndex = daysMap[dia];
    const startHour = parseInt(horas[0].split(':')[0], 10);
    
    if(dayIndex === undefined) return;

    const target = document.querySelector(`.slot[data-day="${dayIndex}"][data-hr="${startHour}"]`);
    if(!target) return;

    const el = document.createElement("div");
    const prioridadNombres = {1: 'Baja', 2: 'Media', 3: 'Alta'};
    const prioridadClases  = {1: 'priority-baja', 2: 'priority-media', 3: 'priority-alta'};

    const priorityClass = prioridadClases[mat.prioridad];

    el.className = `event materia ${priorityClass}`;

    // Tooltip
    el.setAttribute("data-tip", `${mat.name}`);

    target.appendChild(el);
}

  // Renderizar eventos
  function placeEventoCalendario(evt){

    function parseLocalDatetime(dtString) {
      const [datePart, timePart] = dtString.split('T');
      const [y, m, d] = datePart.split('-').map(Number);
      const [h, min] = timePart.split(':').map(Number);
      return new Date(y, m - 1, d, h, min);
    }

    const start = parseLocalDatetime(evt.start);
    const end   = parseLocalDatetime(evt.end);

    // Convertir correctamente: getDay() 0=Dom, 1=Lun... ‚Üí dayIndex 0=Lun, 6=Dom
    let dayIndex = start.getDay() - 1;
    if(dayIndex === -1) dayIndex = 6; // Si es domingo (0), pasar a 6
    
    const startHour = start.getHours();
    
    const target = document.querySelector(`.slot[data-day="${dayIndex}"][data-hr="${startHour}"]`);
    if(!target) {
      console.warn(`No se encontr√≥ slot para evento: ${evt.name}, d√≠a ${dayIndex}, hora ${startHour}`);
      return;
    }
    
    const el = document.createElement("div");
    const prioridadNombres = {1: 'Baja', 2: 'Media', 3: 'Alta'};
    const prioridadClases  = {1: 'priority-baja', 2: 'priority-media', 3: 'priority-alta'};
    const priorityClass = prioridadClases[evt.prioridad];
    
    el.className = `event evento ${priorityClass}`;

     // Tooltip
    el.setAttribute("data-tip", `${evt.name}`);

    target.appendChild(el);
}

  // Renderizar todos
  materias.forEach(placeMateriaEvent);
  eventos.forEach(placeEventoCalendario);

  // Manejar formularios de marcar tarea como realizada con AJAX
  document.querySelectorAll('.marcar-tarea-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const idTarea = formData.get('id_tarea');
      const nombreTarea = formData.get('nombre_tarea');
      const csrfToken = formData.get('csrfmiddlewaretoken');
      
      try {
        const response = await fetch('/marcar_realizada/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            id_tarea: idTarea,
            csrfmiddlewaretoken: csrfToken
          })
        });
        
        if (response.ok) {
          // Remover el item del DOM con animaci√≥n
          const item = form.closest('.item');
          if (item) {
            item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(20px)';
            setTimeout(() => {
              item.remove();
              // Si no hay m√°s tareas, mostrar mensaje
              const taskList = document.getElementById('taskList');
              if (taskList.children.length === 0) {
                taskList.innerHTML = '<div style="text-align: center; color: var(--g600); padding: 20px;">¬°No tienes tareas pendientes! üéâ</div>';
              }
            }, 300);
          }
        } else {
          console.error('Error al marcar tarea');
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });
  });

  // Manejar formularios de eliminaci√≥n con confirmaci√≥n y AJAX
  document.querySelectorAll('.eliminar-tarea-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Confirmaci√≥n simple
      const confirmed = window.confirm('¬øEst√°s seguro de que deseas eliminar esta tarea? Esta acci√≥n no se puede deshacer.');
      if (!confirmed) return;

      const formData = new FormData(form);
      const idTarea = formData.get('id_tarea');
      const csrfToken = formData.get('csrfmiddlewaretoken');

      try {
        const response = await fetch('/eliminar_tarea/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ id_tarea: idTarea, csrfmiddlewaretoken: csrfToken })
        });

        if (response.ok) {
          // Remover el item del DOM con animaci√≥n
          const item = form.closest('.item');
          if (item) {
            item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(20px)';
            setTimeout(() => {
              item.remove();
              const taskList = document.getElementById('taskList');
              if (taskList.children.length === 0) {
                taskList.innerHTML = '<div style="text-align: center; color: var(--g600); padding: 20px;">¬°No tienes tareas pendientes! üéâ</div>';
              }
            }, 300);
          }
        } else {
          console.error('Error al eliminar tarea');
          alert('Ocurri√≥ un error al eliminar la tarea. Intenta de nuevo.');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Ocurri√≥ un error de red al eliminar la tarea.');
      }
    });
  });

  const today = new Date().getDay() - 1;
  if (today === -1) today = 6;

  document.querySelectorAll(`.slot[data-day="${today}"]`)
    .forEach(s => s.style.background = "rgba(34, 197, 94, 0.1)"); // Marcar el dia actual con verde

  /* ===== TOOLTIP INTELIGENTE ===== */

const tooltip = document.getElementById("tooltip");

document.querySelectorAll('.event').forEach(ev => {
    ev.addEventListener('mouseenter', e => {
        tooltip.textContent = ev.getAttribute("data-tip");
        tooltip.style.display = "block";

        const rect = ev.getBoundingClientRect();
        const tt = tooltip.getBoundingClientRect();

        // Posici√≥n por defecto (arriba)
        let top = rect.top - tt.height - 8;
        let left = rect.left + rect.width / 2 - tt.width / 2;

        // Si se sale por arriba ‚Üí mostrar abajo
        if (top < 0) {
            top = rect.bottom + 8;
        }
        tooltip.style.top = top + "px";
        tooltip.style.left = left + "px";
    });

    ev.addEventListener('mouseleave', () => {
        tooltip.style.display = "none";
    });
});
</script>
</body>
</html>